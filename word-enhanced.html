<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordMaster Pro | é¢˜å‹å…¨èƒ½ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --success: #10b981;
            --error: #ef4444;
            --gradient: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, sans-serif; transition: all 0.2s ease; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }

        /* --- Header --- */
        header { width: 100%; max-width: 800px; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: var(--bg-card); border: none; font-size: 1.2rem; cursor: pointer; padding: 8px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--text-main); }
        
        /* --- Layout --- */
        .container { width: 100%; max-width: 800px; padding: 0 1.5rem; }
        .card { background: var(--bg-card); border-radius: 24px; padding: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 2rem; display: none; }
        .card.active { display: block; animation: fadeUp 0.4s ease; }
        
        h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem; }
        .subtitle { color: var(--text-sub); margin-bottom: 2rem; }

        /* --- Components --- */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; background: var(--gradient); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn:hover { transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-sub); box-shadow: none; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--error); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); color: white; border: none; }

        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--border); background: var(--input-bg); color: var(--text-main); font-size: 1rem; outline: none; margin-bottom: 1rem; }
        input:focus { border-color: var(--primary); }

        /* --- User & Unit Grid --- */
        .grid-box { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-bottom: 1rem; }
        .chip { padding: 8px; text-align: center; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; user-select: none; position: relative; }
        .chip.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .user-del-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: var(--bg-card); border: 1px solid var(--error); color: var(--error); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; z-index: 10; }

        /* --- Quiz --- */
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 2rem; }
        .progress-fill { height: 100%; background: var(--gradient); width: 0%; transition: width 0.3s; }
        .big-word { font-size: 2.5rem; font-weight: 800; text-align: center; margin-bottom: 0.5rem; }
        .hint-text { text-align: center; color: var(--text-sub); margin-bottom: 2rem; display: block; }
        .shake { animation: shake 0.4s ease; border-color: var(--error) !important; }

        /* --- Mistake & History UI --- */
        .list-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); gap: 1rem; }
        .list-item:last-child { border-bottom: none; }
        .custom-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

        /* Review Selection List */
        .review-select-list { max-height: 200px; overflow-y: auto; background: var(--input-bg); border-radius: 12px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); }

        /* History Details */
        .history-card { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; overflow: hidden; }
        .history-header { padding: 1rem; background: var(--input-bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-body { display: none; padding: 1rem; background: var(--bg-card); }
        .history-body.show { display: block; }
        .history-row { display: grid; grid-template-columns: 2fr 2fr 2fr; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .history-row.wrong { color: var(--error); }
        .history-row.correct { color: var(--success); }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 90%; max-width: 450px; text-align: center; box-shadow: var(--shadow); max-height: 80vh; overflow-y: auto; }
        .check-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; text-align: left; font-size: 0.9rem; color: var(--text-sub); }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Print optimization */
        @media print {
            body { background: white; color: black; }
            header, .btn, .nav-actions, .custom-checkbox, .grid-box, #mistake-actions, .btn-outline, #review-mode-select { display: none !important; }
            .card { display: none; }
            #view-mistakes { display: block !important; box-shadow: none; border: none; }
            .print-table { display: table !important; width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid black; padding: 8px; }
            .list-item { display: none !important; }
            #print-title { display: block !important; }
        }
        .print-table, #print-title { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo">WordMaster Pro</div>
        <div class="nav-actions">
            <button class="icon-btn" onclick="App.toggleTheme()" title="åˆ‡æ¢æ¨¡å¼">ğŸŒ“</button>
            <button class="icon-btn" id="btn-history" onclick="App.showHistory()" style="display:none" title="å†å²è®°å½•">ğŸ“œ</button>
            <button class="icon-btn" id="btn-logout" onclick="App.logout()" style="display:none" title="é€€å‡ºç™»å½•">ğŸšª</button>
        </div>
    </header>

    <div class="container">
        <!-- 1. ç™»å½•ç•Œé¢ -->
        <div id="view-login" class="card active">
            <h2>è°åœ¨å­¦ä¹ ï¼Ÿ</h2>
            <p class="subtitle">è¯·é€‰æ‹©ä½ çš„æ¡£æ¡ˆï¼Œè®°å½•å°†ç‹¬ç«‹ä¿å­˜ã€‚</p>
            <div id="user-grid" class="grid-box"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <input type="text" id="new-user-input" placeholder="è¾“å…¥æ–°åå­—" style="margin:0;">
                <button class="btn" style="width:auto;" onclick="App.createUser()">æ·»åŠ </button>
            </div>
        </div>

        <!-- 2. ä¸»é¡µ -->
        <div id="view-dashboard" class="card">
            <h2 id="welcome-text">Hi!</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">æŒ‘æˆ˜æ¨¡å¼</label>
                <select id="mode-select" onchange="App.toggleBattleMode()">
                    <option value="single">ğŸ‘¤ å•äººç»ƒä¹ </option>
                    <option value="battle">âš”ï¸ åŒäººå¯¹æˆ˜ (æ¥åŠ›æ¨¡å¼)</option>
                </select>
                <div id="battle-options" style="display:none; padding:10px; background:var(--input-bg); border-radius:10px; margin-top:10px;">
                    <label style="font-size:0.9rem; color:var(--text-sub);">é€‰æ‹©å¯¹æ‰‹ (Player B)</label>
                    <select id="opponent-select" style="margin-bottom:0;"></select>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <label style="font-weight:bold;">é€‰æ‹©å•å…ƒ</label>
                    <div>
                        <small onclick="App.selectUnits('all')" style="color:var(--primary); cursor:pointer; margin-right:10px;">å…¨é€‰</small>
                        <small onclick="App.selectUnits('none')" style="cursor:pointer; color:var(--text-sub);">æ¸…ç©º</small>
                    </div>
                </div>
                <div id="unit-grid" class="grid-box" style="max-height:150px; overflow-y:auto;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">é¢˜å‹</label>
                <select id="q-type">
                    <option value="cn_en">æ±‰è¯‘è‹± (çœ‹ä¸­æ–‡å†™è‹±æ–‡)</option>
                    <option value="en_cn">è‹±è¯‘æ±‰ (çœ‹è‹±æ–‡å†™ä¸­æ–‡)</option>
                    <option value="dictation">å¬å†™ (å¬éŸ³å†™è¯)</option>
                </select>
            </div>

            <!-- TTSè¯­éŸ³è®¾ç½® -->
            <div style="background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 10px;">ğŸ”Š è¯­éŸ³è®¾ç½®</h3>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <label style="min-width: 80px;">ä¸­æ–‡éŸ³è‰²:</label>
                    <select id="voice-zh" onchange="App.saveVoiceSettings()" style="flex: 1; margin-bottom: 0;">
                        <option value="">é»˜è®¤</option>
                    </select>
                    <button class="btn btn-outline" style="width: auto; padding: 8px 16px; margin: 0;" onclick="App.testVoice('zh')">è¯•å¬</button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <label style="min-width: 80px;">è‹±æ–‡éŸ³è‰²:</label>
                    <select id="voice-en" onchange="App.saveVoiceSettings()" style="flex: 1; margin-bottom: 0;">
                        <option value="">é»˜è®¤</option>
                    </select>
                    <button class="btn btn-outline" style="width: auto; padding: 8px 16px; margin: 0;" onclick="App.testVoice('en')">è¯•å¬</button>
                </div>
            </div>

            <!-- å‡ºé¢˜é¡ºåºè®¾ç½® -->
            <div style="background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 10px;">ğŸ“‹ å‡ºé¢˜é¡ºåº</h3>
                <select id="word-order" style="margin-bottom: 0;">
                    <option value="random">ä¹±åºï¼ˆéšæœºæ‰“ä¹±ï¼‰</option>
                    <option value="sequential">æ­£åºï¼ˆæŒ‰Unité¡ºåºï¼‰</option>
                </select>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="Game.init()">å¼€å§‹æŒ‘æˆ˜</button>
                <button class="btn btn-outline" style="width:auto;" onclick="App.showMistakes()">ğŸ“• é”™é¢˜æœ¬</button>
            </div>
        </div>

        <!-- 3. ç­”é¢˜ç•Œé¢ -->
        <div id="view-quiz" class="card">
            <div id="battle-info" style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--primary); display:none;">
                å½“å‰å›åˆ: <span id="current-player-display">User</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div style="text-align:center;">
                <div style="font-size:2rem; cursor:pointer; margin-bottom:10px;" onclick="Game.playAudio()">ğŸ”Š</div>
                <div id="q-main" class="big-word">Question</div>
                <div id="q-sub" class="hint-text">Hint</div>
                <input type="text" id="q-input" autocomplete="off" placeholder="è¾“å…¥ç­”æ¡ˆ..." style="text-align:center; font-size:1.2rem;">
                <div id="feedback" style="height:30px; font-weight:bold; margin-bottom:10px;"></div>
                <button class="btn" onclick="Game.checkAnswer()">æäº¤</button>
                <button class="btn btn-outline" onclick="App.goDashboard()" style="margin-top:10px;">é€€å‡º</button>
            </div>
        </div>

        <!-- 4. ä¸­åœºä¼‘æ¯ -->
        <div id="view-intermission" class="card" style="text-align:center;">
            <h1>â¸ï¸</h1>
            <h2>ä¸­åœºä¼‘æ¯</h2>
            <p class="subtitle">è¯·å°†è®¾å¤‡äº¤ç»™ <strong id="next-player-name" style="color:var(--primary)">Player B</strong></p>
            <button class="btn" onclick="Game.startPhase2()">å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹ï¼</button>
        </div>

        <!-- 5. ç»“æœé¡µ -->
        <div id="view-result" class="card" style="text-align:center;">
            <h1>ğŸ‰</h1>
            <h2 id="result-title">æŒ‘æˆ˜ç»“æŸ</h2>
            <div id="result-details" style="margin:20px 0;"></div>
            
            <!-- å¤ä¹ æ¨¡å¼ä¸“ç”¨æ“ä½œåŒº -->
            <div id="review-clear-actions" style="display:none; background:var(--input-bg); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border); text-align:left;">
                <p style="color:var(--success); font-weight:bold; margin-bottom:10px; text-align:center;">æœ¬æ¬¡å¤ä¹ ç­”å¯¹å•è¯ (å¯é€‰åˆ é™¤)</p>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <small>å‹¾é€‰ = åˆ é™¤</small>
                    <small style="color:var(--primary); cursor:pointer;" onclick="App.toggleReviewSelectAll()">å…¨é€‰/åé€‰</small>
                </div>
                <div id="review-correct-list" class="review-select-list"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-danger" onclick="App.deleteSelectedReviewMistakes()">åˆ é™¤é€‰ä¸­</button>
                    <button class="btn btn-outline" onclick="App.goMistakes()">å…¨éƒ¨ä¿ç•™</button>
                </div>
            </div>

            <button id="btn-back-home" class="btn" onclick="App.goDashboard()">è¿”å›ä¸»é¡µ</button>
        </div>

        <!-- 6. é”™é¢˜æœ¬ -->
        <div id="view-mistakes" class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>é”™é¢˜æœ¬</h2>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="App.exportMistakes()">â¬‡ï¸ å¯¼å‡º</button>
                    <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="document.getElementById('import-file').click()">â¬†ï¸ å¯¼å…¥</button>
                    <input type="file" id="import-file" style="display:none" accept=".json" onchange="App.importMistakes(this)">
                </div>
            </div>

            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <button class="btn" style="flex:1;" onclick="App.printMistakes('all')">ğŸ–¨ï¸ æ‰“å°å…¨éƒ¨</button>
                <button class="btn btn-outline" style="flex:1;" onclick="App.printMistakes('new')">ğŸ–¨ï¸ ä»…æ‰“æ–°è¯</button>
                <button class="btn btn-outline" style="flex:0.5; padding-left:0; padding-right:0;" onclick="App.openAddMistakeModal()">â•</button>
            </div>

            <div id="mistake-actions" style="display:flex; justify-content:space-between; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid var(--border);">
                <div>
                    <input type="checkbox" id="select-all" class="custom-checkbox" onchange="App.toggleSelectAll(this)">
                    <label for="select-all" style="display:inline; margin-left:5px; cursor:pointer;">å…¨é€‰</label>
                </div>
                <button class="btn btn-danger" style="width:auto; padding:5px 15px; font-size:0.9rem;" onclick="App.confirmDelete()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            </div>

            <div id="mistake-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>

            <!-- æ‰“å°ä¸“ç”¨æ ‡é¢˜å’Œè¡¨æ ¼ -->
            <h1 id="print-title" style="text-align:center;">é”™é¢˜é›†é”¦</h1>
            <table class="print-table">
                <thead><tr><th>å•è¯</th><th>è¯æ€§</th><th>é‡Šä¹‰</th><th>é”™è¯¯æ¬¡æ•°</th></tr></thead>
                <tbody id="print-tbody"></tbody>
            </table>

            <!-- å¤ä¹ é¢˜å‹é€‰æ‹©ä¸å¼€å§‹æŒ‰é’® -->
            <div style="padding-top:15px; border-top:1px solid var(--border);">
                <label style="font-size:0.9rem; font-weight:bold; color:var(--text-sub); display:block; margin-bottom:5px;">å¤ä¹ å‡ºé¢˜æ¨¡å¼ï¼š</label>
                <select id="review-mode-select" style="margin-bottom:10px;">
                    <option value="cn_en">æ±‰è¯‘è‹± (çœ‹ä¸­æ–‡å†™è‹±æ–‡)</option>
                    <option value="en_cn">è‹±è¯‘æ±‰ (çœ‹è‹±æ–‡å†™ä¸­æ–‡)</option>
                    <option value="dictation">å¬å†™ (å¬éŸ³å†™è¯)</option>
                    <option value="original">ğŸ”„ æŒ‰å½“æ—¶é”™é¢˜è®°å½•</option>
                </select>
                
                <label style="font-size:0.9rem; font-weight:bold; color:var(--text-sub); display:block; margin-bottom:5px;">å¤ä¹ é¡ºåºï¼š</label>
                <select id="review-order" style="margin-bottom:10px;">
                    <option value="random">ä¹±åºï¼ˆéšæœºï¼‰</option>
                    <option value="sequential">æ­£åºï¼ˆæŒ‰æ·»åŠ é¡ºåºï¼‰</option>
                </select>
                
                <button class="btn" onclick="Game.reviewMistakes()">å¼€å§‹å¤ä¹ é”™é¢˜</button>
                
                <div style="margin-top:10px; text-align:center;">
                    <small style="color:var(--text-sub); cursor:pointer; text-decoration:underline;" onclick="App.goDashboard()">è¿”å›ä¸»é¡µ</small>
                </div>
            </div>
        </div>

        <!-- 7. å†å²è®°å½• -->
        <div id="view-history" class="card">
            <h2>ğŸ“œ ç­”é¢˜è®°å½•</h2>
            <div id="history-list" style="max-height:500px; overflow-y:auto;"></div>
            <button class="btn btn-outline" onclick="App.goDashboard()" style="margin-top:20px;">è¿”å›</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šç¡®è®¤åˆ é™¤å•è¯ -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <h3 style="margin-bottom:15px; color:var(--error);">ç¡®è®¤åˆ é™¤?</h3>
            <p style="margin-bottom:20px; color:var(--text-sub);">è¿™äº›é”™é¢˜å°†ä»é”™é¢˜æœ¬ä¸­ç§»é™¤ã€‚</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="document.getElementById('delete-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="App.executeDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ‰‹åŠ¨æ·»åŠ é”™é¢˜ -->
    <div class="modal-overlay" id="add-manual-modal">
        <div class="modal" style="max-width:600px;">
            <h3 style="margin-bottom:15px;">æ·»åŠ å•è¯è‡³é”™é¢˜æœ¬</h3>
            <div id="add-step-1">
                <p class="subtitle">é€‰æ‹©å•å…ƒ:</p>
                <div id="manual-unit-grid" class="grid-box"></div>
            </div>
            <div id="add-step-2" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button class="btn-outline" style="width:auto; padding:5px 10px;" onclick="App.resetManualAdd()">â† è¿”å›</button>
                    <span style="font-weight:bold;">é€‰æ‹©å•è¯</span>
                </div>
                <div id="manual-word-list" style="max-height:300px; overflow-y:auto; text-align:left;"></div>
                <button class="btn" style="margin-top:15px;" onclick="App.saveManualWords()">ç¡®è®¤æ·»åŠ </button>
            </div>
            <button class="btn btn-outline" style="margin-top:20px;" onclick="document.getElementById('add-manual-modal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šç”¨æˆ·åˆ é™¤ -->
    <div class="modal-overlay" id="user-delete-modal">
        <div class="modal">
            <h2 style="color:var(--error); margin-bottom:10px;">âš ï¸ å±é™©æ“ä½œ</h2>
            <p style="margin-bottom:20px;">åˆ é™¤ç”¨æˆ· <strong id="del-user-name" style="color:var(--primary)"></strong></p>
            <div style="background:var(--input-bg); padding:15px; border-radius:12px; margin-bottom:20px;">
                <div class="check-row"><input type="checkbox" id="chk-1" class="custom-checkbox" onchange="App.checkUserDelState()"><label for="chk-1">ç¡®è®¤æ¸…ç©ºå†å²</label></div>
                <div class="check-row"><input type="checkbox" id="chk-2" class="custom-checkbox" onchange="App.checkUserDelState()"><label for="chk-2">ç¡®è®¤æ¸…ç©ºé”™é¢˜</label></div>
                <div class="check-row"><input type="checkbox" id="chk-3" class="custom-checkbox" onchange="App.checkUserDelState()"><label for="chk-3">ä¸å¯æ’¤é”€</label></div>
            </div>
            <p style="font-size:0.9rem; margin-bottom:5px;">è¾“å…¥ï¼š<span id="del-confirm-str" style="font-family:monospace; font-weight:bold;"></span></p>
            <input type="text" id="del-user-input" oninput="App.checkUserDelState()">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="document.getElementById('user-delete-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="btn-final-del-user" disabled onclick="App.executeUserDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>

<script>
/* ================= DATA (è¯·ç²˜è´´30å•å…ƒå®Œæ•´å†…å®¹) ================= */
const rawData = `
# UNIT 1
1. bayï¼šn. æµ·æ¹¾
2. bloomï¼šn. èŠ±æœµ
3. cliffï¼šn. æ‚¬å´–
4. climateï¼šn. æ°”å€™
5. coastï¼šn. æµ·å²¸
6. coralï¼šn. çŠç‘š
7. districtï¼šn. åŒºåŸŸ
8. fossilï¼šn. åŒ–çŸ³
9. galaxyï¼šn. æ˜Ÿç³»
10. pollutionï¼šn. æ±¡æŸ“
11. pondï¼šn. æ± å¡˜
12. recycleï¼šv. å›æ”¶åˆ©ç”¨
13. regionï¼šn. åœ°åŒº
14. sceneryï¼šn. é£æ™¯
15. shoreï¼šn. æµ·æ»¨
16. soilï¼šn. åœŸå£¤
17. streamï¼šn. å°æºª
18. trashï¼šn. åƒåœ¾
19. universeï¼šn. å®‡å®™
20. waveï¼šn. æ³¢æµª

# UNIT 2
1. adaptï¼šv. é€‚åº”
2. continentï¼šn. å¤§é™†
3. disasterï¼šn. ç¾éš¾
4. environmentï¼šn. ç¯å¢ƒ
5. flameï¼šn. ç«ç„°
6. floodï¼šn. æ´ªæ°´
7. forecastï¼šn. é¢„æŠ¥
8. freezeï¼šv. å†·å†»
9. frozenï¼šadj. å†·å†»çš„
10. globalï¼šadj. å…¨çƒçš„
11. humidï¼šadj. æ½®æ¹¿çš„
12. impactï¼šn. å½±å“
13. landscapeï¼šn. åœ°è²Œ
14. oxygenï¼šn. æ°§æ°”
15. peakï¼šn. å±±å³°
16. polarï¼šadj. æåœ°çš„
17. riseï¼šv. ä¸Šå‡
18. rootï¼šn. æ ¹
19. underwaterï¼šadj. åœ¨æ°´ä¸‹çš„
20. waveï¼šn. æ³¢æµª

# UNIT 3
1. borderï¼šn. è¾¹å¢ƒ
2. brakeï¼šn. åˆ¶åŠ¨å™¨
3. convenientï¼šadj. æ–¹ä¾¿çš„
4. crashï¼šn. ç¢°æ’
5. crewï¼šn. å·¥ä½œäººå‘˜
6. cycleï¼šn. å¾ªç¯
7. easternï¼šadj. ä¸œæ–¹çš„
8. entryï¼šn. å…¥å£
9. expeditionï¼šn. æ¢é™©
10. movementï¼šn. è¿åŠ¨
11. railï¼šn. é“è·¯
12. reserveï¼šv. é¢„è®¢
13. resortï¼šn. åº¦å‡èƒœåœ°
14. sailorï¼šn. æ°´æ‰‹
15. souvenirï¼šn. çºªå¿µå“
16. tourismï¼šn. æ—…æ¸¸ä¸š
17. transportationï¼šn. äº¤é€š
18. tropicalï¼šadj. çƒ­å¸¦çš„
19. wanderï¼šv. æ¼«æ­¥
20. travelï¼šn. æ—…è¡Œ

# UNIT 4
1. abroadï¼šadv. åœ¨å›½å¤–
2. aheadï¼šadv. åœ¨å‰é¢
3. aircraftï¼šn. é£æœº
4. baggageï¼šn. è¡Œæ
5. campsiteï¼šn. éœ²è¥åœ°
6. cruiseï¼šn. ä¹˜èˆ¹æ¸¸è§ˆ
7. destinationï¼šn. ç›®çš„åœ°
8. fuelï¼šn. ç‡ƒæ–™
9. jetï¼šn. å–·æ°”å¼é£æœº
10. laneï¼šn. è½¦é“
11. launchï¼šv. å¯åŠ¨
12. motorï¼šn. å‘åŠ¨æœº
13. rushï¼šv. åŒ†å¿™
14. signalï¼šn. ä¿¡å·
15. southernï¼šadj. å—æ–¹çš„
16. steerï¼šv. é©¾é©¶
17. tunnelï¼šn. éš§é“
18. vehicleï¼šn. äº¤é€šå·¥å…·
19. viaï¼šprep. é€šè¿‡
20. westernï¼šadj. è¥¿æ–¹çš„

# UNIT 5
1. agentï¼šn. ä»£ç†äºº
2. applyï¼šv. ç”³è¯·
3. assistantï¼šn. åŠ©ç†
4. chiefï¼šn. é¦–é¢†
5. clientï¼šn. å®¢æˆ·
6. committeeï¼šn. å§”å‘˜ä¼š
7. editorï¼šn. ç¼–è¾‘
8. full-timeï¼šadj. å…¨èŒçš„
9. hireï¼šv. é›‡ä½£
10. importï¼šn. è¿›å£
11. issueï¼šn. é—®é¢˜
12. manufactureï¼šv. åˆ¶é€ 
13. ministerï¼šn. éƒ¨é•¿
14. priestï¼šn. ç‰§å¸ˆ
15. producerï¼šn. åˆ¶ä½œäºº
16. productionï¼šn. åˆ¶ä½œ
17. promotionï¼šn. æ™‹å‡
18. retireï¼šv. é€€ä¼‘
19. specialistï¼šn. ä¸“å®¶
20. workï¼šn. å·¥ä½œ

# UNIT 6
1. barberï¼šn. ç†å‘å¸ˆ
2. bossï¼šn. è€æ¿
3. capableï¼šadj. æœ‰èƒ½åŠ›çš„
4. chartï¼šn. å›¾è¡¨
5. contractï¼šn. åˆåŒ
6. debateï¼šn. è¾©è®º
7. employï¼šv. é›‡ä½£
8. expertï¼šn. ä¸“å®¶
9. guideï¼šn. å‘å¯¼
10. professionï¼šn. èŒä¸š
11. profitï¼šn. åˆ©æ¶¦
12. promoteï¼šv. æ™‹å‡
13. reportï¼šn. æŠ¥å‘Š
14. responsibilityï¼šn. è´£ä»»
15. scheduleï¼šn. æ—¥ç¨‹è¡¨
16. servantï¼šn. ä»†äºº
17. signatureï¼šn. ç­¾å
18. spareï¼šadj. ç©ºé—²çš„
19. strikeï¼šn. ç½¢å·¥
20. surveyï¼šn. è°ƒæŸ¥

# UNIT 7
1. allyï¼šn. ä¼™ä¼´
2. argueï¼šv. äº‰è¾©
3. armorï¼šn. è£…ç”²
4. arrowï¼šn. ç®­
5. attackï¼šn. æ”»å‡»
6. attentionï¼šn. æ³¨æ„åŠ›
7. captainï¼šn. é˜Ÿé•¿
8. defeatï¼šv. å‡»è´¥
9. guardï¼šn. å«å…µ
10. gunï¼šn. æª
11. helmetï¼šn. å¤´ç›”
12. jeepï¼šn. å‰æ™®è½¦
13. militaryï¼šadj. å†›äº‹çš„
14. navyï¼šn. æµ·å†›
15. peaceï¼šn. å’Œå¹³
16. soldierï¼šn. å£«å…µ
17. submarineï¼šn. æ½œæ°´è‰‡
18. tankï¼šn. å¦å…‹
19. weaponï¼šn. æ­¦å™¨
20. warï¼šn. æˆ˜äº‰

# UNIT 8
1. agreementï¼šn. åè®®
2. armyï¼šn. å†›é˜Ÿ
3. aviationï¼šn. èˆªç©º
4. battleï¼šn. æˆ˜æ–—
5. capitalï¼šn. é¦–éƒ½
6. charityï¼šn. æ…ˆå–„
7. crisisï¼šn. å±æœº
8. gainï¼šv. è·å¾—
9. governmentï¼šn. æ”¿åºœ
10. independentï¼šadj. ç‹¬ç«‹çš„
11. leaderï¼šn. é¢†å¯¼è€…
12. marineï¼šadj. æµ·å†›çš„
13. nationï¼šn. å›½å®¶
14. nationalï¼šadj. å›½å®¶çš„
15. officialï¼šn. å®˜å‘˜
16. presidentï¼šn. æ€»ç»Ÿ
17. publicï¼šadj. å…¬å…±çš„
18. revolutionï¼šn. é©å‘½
19. socialï¼šadj. ç¤¾ä¼šçš„
20. societyï¼šn. ç¤¾ä¼š

# UNIT 9
1. authorityï¼šn. æƒå¨
2. blameï¼šv. è´£å¤‡
3. candidateï¼šn. å€™é€‰äºº
4. citizenï¼šn. å…¬æ°‘
5. councilï¼šn. è®®ä¼š
6. democracyï¼šn. æ°‘ä¸»
7. denyï¼šv. å¦è®¤
8. domesticï¼šadj. å›½å†…çš„
9. electionï¼šn. é€‰ä¸¾
10. federalï¼šadj. è”é‚¦çš„
11. governï¼šv. ç®¡ç†
12. influenceï¼šn. å½±å“
13. massiveï¼šadj. å·¨å¤§çš„
14. parliamentï¼šn. å›½ä¼š
15. policyï¼šn. æ”¿ç­–
16. politicianï¼šn. æ”¿æ²»å®¶
17. politicsï¼šn. æ”¿æ²»
18. regulationï¼šn. è§„ç« 
19. republicï¼šn. å…±å’Œå›½
20. royalï¼šadj. çš‡å®¶çš„

# UNIT 10
1. clueï¼šn. çº¿ç´¢
2. crimeï¼šn. ç½ªè¡Œ
3. criminalï¼šn. ç½ªçŠ¯
4. dangerï¼šn. å±é™©
5. deathï¼šn. æ­»äº¡
6. evidenceï¼šn. è¯æ®
7. guiltyï¼šadj. æœ‰ç½ªçš„
8. illegalï¼šadj. éæ³•çš„
9. jailï¼šn. ç›‘ç‹±
10. justiceï¼šn. æ­£ä¹‰
11. lawï¼šn. æ³•å¾‹
12. legalï¼šadj. åˆæ³•çš„
13. policeï¼šn. è­¦å¯Ÿ
14. prisonï¼šn. ç›‘ç‹±
15. prisonerï¼šn. å›šçŠ¯
16. punishï¼šv. æƒ©ç½š
17. punishmentï¼šn. å¤„ç½š
18. ruleï¼šn. è§„åˆ™
19. thiefï¼šn. å°å·
20. trickï¼šn. è¯¡è®¡

# UNIT 11
1. accuseï¼šv. æ§å‘Š
2. armedï¼šadj. æ­¦è£…çš„
3. arrestï¼šn. é€®æ•
4. bulletï¼šn. å­å¼¹
5. commitï¼šv. çŠ¯ç½ª
6. cruelï¼šadj. æ®‹å¿çš„
7. deliberateï¼šadj. æ•…æ„çš„
8. fearï¼šn. å®³æ€•
9. frightenï¼šv. ä½¿å®³æ€•
10. holdï¼šv. å…³æŠ¼
11. innocentï¼šadj. æ— è¾œçš„
12. penaltyï¼šn. å¤„ç½š
13. potentialï¼šadj. æ½œåœ¨çš„
14. pretendï¼šv. å‡è£…
15. riskï¼šn. é£é™©
16. shockï¼šn. éœ‡æƒŠ
17. suspectï¼šn. å«Œç–‘äºº
18. suspicionï¼šn. æ€€ç–‘
19. trialï¼šn. å®¡åˆ¤
20. witnessï¼šn. ç›®å‡»è€…

# UNIT 12
1. arithmeticï¼šn. ç®—æœ¯
2. billionï¼šnum. åäº¿
3. calculateï¼šv. è®¡ç®—
4. compassï¼šn. æŒ‡å—é’ˆ
5. divideï¼šv. é™¤
6. divisionï¼šn. é™¤æ³•
7. dozenï¼šn. ä¸€æ‰“
8. equationï¼šn. æ–¹ç¨‹å¼
9. evenï¼šadj. å¶æ•°çš„
10. formulaï¼šn. å…¬å¼
11. fractionï¼šn. åˆ†æ•°
12. graphï¼šn. æ›²çº¿å›¾
13. lessï¼šadj. æ›´å°‘çš„
14. minusï¼šprep. å‡
15. multiplyï¼šv. ä¹˜
16. ordinalï¼šadj. åºæ•°çš„
17. percentï¼šn. ç™¾åˆ†æ¯”
18. plusï¼šprep. åŠ 
19. quarterï¼šn. å››åˆ†ä¹‹ä¸€
20. subtractï¼šv. æ‰£é™¤

# UNIT 13
1. certificateï¼šn. è¯ä¹¦
2. creativityï¼šn. åˆ›é€ åŠ›
3. degreeï¼šn. å­¦ä½
4. demandï¼šn. éœ€æ±‚
5. directionï¼šn. æ–¹å‘
6. educationï¼šn. æ•™è‚²
7. elementaryï¼šadj. åˆçº§çš„
8. examinationï¼šn. è€ƒè¯•
9. focusï¼šn. ç„¦ç‚¹
10. instructionï¼šn. è¯´æ˜
11. intelligenceï¼šn. æ™ºåŠ›
12. knowledgeï¼šn. çŸ¥è¯†
13. majorï¼šn. ä¸“ä¸š
14. markï¼šn. åˆ†æ•°
15. masterï¼šv. æŒæ¡
16. mentorï¼šn. å¯¼å¸ˆ
17. sectionï¼šn. éƒ¨åˆ†
18. solveï¼šv. è§£å†³
19. standardï¼šn. æ ‡å‡†
20. tuitionï¼šn. å­¦è´¹

# UNIT 14
1. academicï¼šadj. å­¦æœ¯çš„
2. curriculumï¼šn. è¯¾ç¨‹
3. diplomaï¼šn. æ–‡å‡­
4. draftï¼šn. è‰ç¨¿
5. educateï¼šv. æ•™è‚²
6. educationalï¼šadj. æ•™è‚²çš„
7. failï¼šv. ä¸åŠæ ¼
8. graduationï¼šn. æ¯•ä¸š
9. institutionï¼šn. æœºæ„
10. lecturerï¼šn. è®²å¸ˆ
11. literacyï¼šn. è¯»å†™èƒ½åŠ›
12. minorï¼šadj. æ¬¡è¦çš„
13. philosophyï¼šn. å“²å­¦
14. progressiveï¼šadj. è¿›æ­¥çš„
15. referenceï¼šn. å‚è€ƒ
16. termï¼šn. å­¦æœŸ
17. tutorï¼šn. å¯¼å¸ˆ
18. tutorialï¼šn. è¾…å¯¼è¯¾
19. unionï¼šn. åä¼š
20. studyï¼šn. å­¦ä¹ 

# UNIT 15
1. annoyï¼šv. ä½¿æ¼æ€’
2. beliefï¼šn. ä¿¡å¿µ
3. belongï¼šv. å±äº
4. charmï¼šn. é­…åŠ›
5. cheatï¼šv. æ¬ºéª—
6. depressedï¼šadj. æ²®ä¸§çš„
7. disappointï¼šv. ä½¿å¤±æœ›
8. embarrassedï¼šadj. å°´å°¬çš„
9. intelligentï¼šadj. èªæ˜çš„
10. jealousï¼šadj. å«‰å¦’çš„
11. livelyï¼šadj. æ´»æ³¼çš„
12. lonelyï¼šadj. å­¤ç‹¬çš„
13. miserableï¼šadj. ç—›è‹¦çš„
14. negativeï¼šadj. æ¶ˆæçš„
15. nervousï¼šadj. ç´§å¼ çš„
16. positiveï¼šadj. ç§¯æçš„
17. prideï¼šn. è‡ªè±ª
18. respectï¼šv. å°Šé‡
19. satisfyï¼šv. ä½¿æ»¡æ„
20. severeï¼šadj. ä¸¥å‰çš„

# UNIT 16
1. angerï¼šn. æ„¤æ€’
2. anxietyï¼šn. ç„¦è™‘
3. anxiousï¼šadj. æ‹…å¿§çš„
4. appealï¼šn. å¸å¼•
5. appreciateï¼šv. æ„Ÿæ¿€
6. awareï¼šadj. æ„è¯†åˆ°çš„
7. awkwardï¼šadj. ç¬¨æ‹™çš„
8. comfortï¼šn. å®‰æ…°
9. commandï¼šn. å‘½ä»¤
10. concernï¼šn. æ‹…å¿§
11. confidenceï¼šn. ä¿¡å¿ƒ
12. esteemï¼šn. å°Šé‡
13. extremeï¼šadj. æåº¦çš„
14. frightï¼šn. æƒŠå“
15. griefï¼šn. æ‚²ç—›
16. hopelessï¼šadj. ç»æœ›çš„
17. sensibleï¼šadj. æ˜æ™ºçš„
18. tenseï¼šadj. ç´§ç»·çš„
19. thoughtfulï¼šadj. ä½“è´´çš„
20. wisdomï¼šn. æ™ºæ…§
`;

function parseData(txt) {
    const units = []; let cur = 0;
    txt.split('\n').forEach(line => {
        line = line.trim(); if(!line) return;
        if(line.includes('UNIT')) cur = parseInt(line.match(/\d+/)[0]);
        else {
            const m = line.match(/^\d+\.\s*([a-zA-Z]+)\s*[ï¼š:]\s*([a-z.]+)\s+(.+)$/);
            if(m && cur > 0) units.push({u: cur, en: m[1], type: m[2], cn: m[3], id: `${cur}-${m[1]}`});
        }
    });
    if(cur < 30) for(let i=cur+1; i<=30; i++) units.push({u: i, en: 'demo', type: 'n.', cn: 'æ¼”ç¤º', id: `${i}-demo`});
    return units;
}
const ALL_WORDS = parseData(rawData);

/* ================= DATABASE ================= */
const DB = {
    // âš ï¸ ä¿æŒ vm_users_v3 ä»¥ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
    get: () => JSON.parse(localStorage.getItem('wm_users_v3')) || {},
    save: (data) => localStorage.setItem('wm_users_v3', JSON.stringify(data)),
    
    initUser: (name) => {
        const d = DB.get();
        if(!d[name]) { d[name] = { mistakes: {}, history: [], lastPrint: 0 }; DB.save(d); }
    },
    deleteUser: (name) => {
        const d = DB.get(); delete d[name]; DB.save(d);
    },
    // æ›´æ–°ï¼šå¢åŠ  qType å‚æ•°ï¼Œè®°å½•é”™é¢˜æ—¶çš„é¢˜å‹
    addMistake: (name, word, qType) => {
        const d = DB.get();
        // é»˜è®¤é¢˜å‹ä¸º cn_en (å¦‚æœä»¥å‰æ²¡è®°å½•è¿‡)
        const typeToSave = qType || 'cn_en';
        
        if(!d[name].mistakes[word.id]) {
            d[name].mistakes[word.id] = {
                ...word, 
                count: 1, 
                addedAt: Date.now(),
                errorType: typeToSave // è®°å½•é”™è¯¯ç±»å‹
            };
        } else {
            d[name].mistakes[word.id].count++;
            d[name].mistakes[word.id].errorType = typeToSave; // æ›´æ–°ä¸ºæœ€æ–°é”™è¯¯ç±»å‹
        }
        DB.save(d);
    },
    removeMistake: (name, id) => {
        const d = DB.get(); delete d[name].mistakes[id]; DB.save(d);
    },
    addHistory: (name, record) => {
        const d = DB.get(); d[name].history.unshift(record); 
        if(d[name].history.length > 50) d[name].history.pop();
        DB.save(d);
    },
    updateLastPrint: (name) => {
        const d = DB.get(); d[name].lastPrint = Date.now(); DB.save(d);
    }
};

/* ================= APP LOGIC ================= */
const App = {
    user: null, units: new Set(), userToDelete: null, reviewCorrectList: [],
    
    init: () => {
        const t = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', t);
        App.renderUserGrid(); App.renderUnitGrid();
        
        // åŠ è½½TTSéŸ³è‰²åˆ—è¡¨
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = App.loadVoices;
        }
        App.loadVoices();
    },
    
    // TTSéŸ³è‰²ç®¡ç†
    loadVoices: () => {
        const voices = window.speechSynthesis.getVoices();
        const zhSelect = document.getElementById('voice-zh');
        const enSelect = document.getElementById('voice-en');
        
        if (!zhSelect || !enSelect) return;
        
        zhSelect.innerHTML = '<option value="">é»˜è®¤</option>';
        enSelect.innerHTML = '<option value="">é»˜è®¤</option>';
        
        // ä¸­æ–‡éŸ³è‰²
        voices.filter(v => v.lang.startsWith('zh')).forEach(v => {
            zhSelect.innerHTML += `<option value="${v.name}">${v.name} (${v.lang})</option>`;
        });
        
        // è‹±æ–‡éŸ³è‰²
        voices.filter(v => v.lang.startsWith('en')).forEach(v => {
            enSelect.innerHTML += `<option value="${v.name}">${v.name} (${v.lang})</option>`;
        });
        
        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        const saved = JSON.parse(localStorage.getItem('tts_settings') || '{}');
        if (saved.zh) zhSelect.value = saved.zh;
        if (saved.en) enSelect.value = saved.en;
    },
    
    saveVoiceSettings: () => {
        const settings = {
            zh: document.getElementById('voice-zh')?.value || '',
            en: document.getElementById('voice-en')?.value || ''
        };
        localStorage.setItem('tts_settings', JSON.stringify(settings));
    },
    
    testVoice: (lang) => {
        const text = lang === 'zh' ? 'ä½ å¥½ï¼Œè¿™æ˜¯æµ‹è¯•è¯­éŸ³' : 'Hello, this is a test voice';
        const voiceName = document.getElementById(`voice-${lang}`)?.value;
        Game.speak(text, lang === 'zh' ? 'zh-CN' : 'en-US', voiceName);
    },

    toggleTheme: () => {
        const n = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', n); localStorage.setItem('theme', n);
    },

    // User Flow
    renderUserGrid: () => {
        const box = document.getElementById('user-grid'); box.innerHTML = '';
        Object.keys(DB.get()).forEach(u => {
            const el = document.createElement('div'); el.className = 'chip';
            el.innerHTML = `ğŸ‘¤ ${u} <div class="user-del-btn" onclick="event.stopPropagation();App.promptDeleteUser('${u}')">âœ•</div>`;
            el.onclick = () => App.login(u); box.appendChild(el);
        });
    },
    createUser: () => {
        const n = document.getElementById('new-user-input').value.trim();
        if(n) { DB.initUser(n); document.getElementById('new-user-input').value = ''; App.renderUserGrid(); }
    },
    login: (n) => {
        App.user = n;
        document.getElementById('welcome-text').innerText = `Hi, ${n}!`;
        document.getElementById('btn-history').style.display = 'block';
        document.getElementById('btn-logout').style.display = 'block';
        const sel = document.getElementById('opponent-select'); sel.innerHTML = '';
        Object.keys(DB.get()).forEach(u => { if(u !== n) sel.innerHTML += `<option value="${u}">${u}</option>`; });
        App.switchView('view-dashboard');
    },
    logout: () => { App.user = null; App.switchView('view-login'); document.getElementById('btn-history').style.display = 'none'; document.getElementById('btn-logout').style.display = 'none'; },

    // Deletion
    promptDeleteUser: (n) => {
        App.userToDelete = n; document.getElementById('del-user-name').innerText = n;
        document.getElementById('del-confirm-str').innerText = `æˆ‘ç¡®è®¤åˆ é™¤ç”¨æˆ·${n}`;
        ['chk-1','chk-2','chk-3'].forEach(i=>document.getElementById(i).checked=false);
        document.getElementById('del-user-input').value=''; document.getElementById('btn-final-del-user').disabled=true;
        document.getElementById('user-delete-modal').style.display = 'flex';
    },
    checkUserDelState: () => {
        const ok = ['chk-1','chk-2','chk-3'].every(i=>document.getElementById(i).checked) && 
                   document.getElementById('del-user-input').value === `æˆ‘ç¡®è®¤åˆ é™¤ç”¨æˆ·${App.userToDelete}`;
        document.getElementById('btn-final-del-user').disabled = !ok;
    },
    executeUserDelete: () => { DB.deleteUser(App.userToDelete); App.renderUserGrid(); document.getElementById('user-delete-modal').style.display='none'; },

    // Nav
    switchView: (id) => { document.querySelectorAll('.card').forEach(c=>c.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); },
    goDashboard: () => { App.switchView('view-dashboard'); Game.isReview = false; },
    goMistakes: () => App.showMistakes(),

    // Units
    renderUnitGrid: () => {
        const box = document.getElementById('unit-grid'); box.innerHTML = '';
        for(let i=1; i<=30; i++) {
            const el = document.createElement('div'); el.className = 'chip'; el.innerText = `U ${i}`;
            el.onclick = () => { if(App.units.has(i)) {App.units.delete(i);el.classList.remove('selected');} else {App.units.add(i);el.classList.add('selected');} };
            box.appendChild(el);
        }
    },
    selectUnits: (m) => {
        const c = document.querySelectorAll('#unit-grid .chip');
        if(m === 'all') { for(let i=1; i<=30; i++) App.units.add(i); c.forEach(x=>x.classList.add('selected')); }
        else { App.units.clear(); c.forEach(x=>x.classList.remove('selected')); }
    },
    toggleBattleMode: () => { document.getElementById('battle-options').style.display = document.getElementById('mode-select').value === 'battle' ? 'block' : 'none'; },

    // Mistake Book
    showMistakes: () => {
        App.switchView('view-mistakes');
        const list = document.getElementById('mistake-list'); list.innerHTML = '';
        document.getElementById('select-all').checked = false;
        const data = DB.get()[App.user].mistakes;
        const ids = Object.keys(data);
        if(ids.length === 0) list.innerHTML = '<div style="text-align:center;padding:20px;color:#aaa">æš‚æ— é”™é¢˜</div>';
        ids.forEach(id => {
            const w = data[id];
            const div = document.createElement('div'); div.className = 'list-item';
            div.innerHTML = `<input type="checkbox" class="custom-checkbox mistake-check" value="${id}"><div style="flex:1;"><strong style="color:var(--primary)">${w.en}</strong><div style="font-size:0.9rem;color:#666">${w.type} ${w.cn}</div></div><span style="color:var(--error);font-size:0.9rem">é”™ ${w.count}æ¬¡</span>`;
            list.appendChild(div);
        });
    },
    toggleSelectAll: (el) => document.querySelectorAll('.mistake-check').forEach(cb=>cb.checked=el.checked),
    confirmDelete: () => { if(document.querySelectorAll('.mistake-check:checked').length) document.getElementById('delete-modal').style.display='flex'; },
    executeDelete: () => {
        document.querySelectorAll('.mistake-check:checked').forEach(cb => DB.removeMistake(App.user, cb.value));
        document.getElementById('delete-modal').style.display = 'none'; App.showMistakes();
    },

    // Export / Import
    exportMistakes: () => {
        const data = DB.get()[App.user].mistakes;
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${App.user}_mistakes_${new Date().toISOString().slice(0,10)}.json`; a.click();
    },
    importMistakes: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                Object.values(imported).forEach(w => DB.addMistake(App.user, w));
                alert('å¯¼å…¥æˆåŠŸï¼å·²åˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬ã€‚'); App.showMistakes();
            } catch(err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
        };
        reader.readAsText(file); input.value = '';
    },

    // Printing
    printMistakes: (mode) => {
        const data = DB.get()[App.user].mistakes;
        const tbody = document.getElementById('print-tbody'); tbody.innerHTML = '';
        const lastP = DB.get()[App.user].lastPrint || 0;
        let count = 0;
        Object.values(data).forEach(w => {
            const added = w.addedAt || 0;
            if(mode === 'all' || added > lastP) {
                tbody.innerHTML += `<tr><td>${w.en}</td><td>${w.type}</td><td>${w.cn}</td><td>${w.count}</td></tr>`;
                count++;
            }
        });
        if(count === 0 && mode === 'new') return alert('ä¸Šæ¬¡æ‰“å°åæ²¡æœ‰æ–°å¢é”™é¢˜');
        document.getElementById('print-title').style.display='block';
        window.print();
        document.getElementById('print-title').style.display='none';
        if(mode === 'new') DB.updateLastPrint(App.user);
    },

    // Manual Add
    openAddMistakeModal: () => { document.getElementById('add-manual-modal').style.display='flex'; App.resetManualAdd(); },
    resetManualAdd: () => {
        document.getElementById('add-step-1').style.display='block'; document.getElementById('add-step-2').style.display='none';
        const g = document.getElementById('manual-unit-grid'); g.innerHTML='';
        for(let i=1;i<=30;i++){ const b=document.createElement('div');b.className='chip';b.innerText=`U ${i}`;b.onclick=()=>App.showWordsManual(i);g.appendChild(b); }
    },
    showWordsManual: (u) => {
        document.getElementById('add-step-1').style.display='none'; document.getElementById('add-step-2').style.display='block';
        const l = document.getElementById('manual-word-list'); l.innerHTML='';
        const ex = DB.get()[App.user].mistakes;
        const w = ALL_WORDS.filter(x => x.u === u && !ex[x.id]);
        if(!w.length) { l.innerHTML='<div style="color:#999">è¯¥å•å…ƒå•è¯å·²å…¨éƒ¨åœ¨é”™é¢˜æœ¬</div>'; return; }
        w.forEach(x => {
            const d=document.createElement('div');d.style.padding='8px';d.style.borderBottom='1px solid #eee';
            d.innerHTML=`<label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" class="manual-add-check custom-checkbox" value="${x.id}" style="margin-right:10px"><span><b>${x.en}</b> <span style="font-size:0.8rem;color:#666">${x.cn}</span></span></label>`;
            l.appendChild(d);
        });
    },
    saveManualWords: () => {
        document.querySelectorAll('.manual-add-check:checked').forEach(cb=>{ const w=ALL_WORDS.find(x=>x.id===cb.value); if(w) DB.addMistake(App.user, w); });
        document.getElementById('add-manual-modal').style.display='none'; App.showMistakes();
    },

    // Review Select
    toggleReviewSelectAll: () => {
        const cbs = document.querySelectorAll('.review-correct-check');
        const allChecked = Array.from(cbs).every(c => c.checked);
        cbs.forEach(c => c.checked = !allChecked);
    },
    deleteSelectedReviewMistakes: () => {
        const checked = document.querySelectorAll('.review-correct-check:checked');
        if(checked.length === 0) return alert('æœªé€‰æ‹©ä»»ä½•å•è¯');
        checked.forEach(cb => DB.removeMistake(App.user, cb.value));
        App.showMistakes();
    },

    // History
    showHistory: () => {
        App.switchView('view-history'); const box=document.getElementById('history-list'); box.innerHTML='';
        const data = DB.get()[App.user].history || [];
        if(!data.length) box.innerHTML='<div style="text-align:center;padding:20px;color:#aaa">æš‚æ— è®°å½•</div>';
        data.forEach(r => {
            const d = new Date(r.time).toLocaleString();
            const m = r.mode === 'battle' ? 'åŒäººå¯¹æˆ˜' : (r.isReview ? 'é”™é¢˜å¤ä¹ ' : 'å•äººç»ƒä¹ ');
            const card = document.createElement('div'); card.className = 'history-card';
            card.innerHTML = `<div class="history-header" onclick="this.nextElementSibling.classList.toggle('show')"><div><strong>${d}</strong><div style="font-size:0.85rem;color:#666">${m} | å¾—åˆ†: ${r.score}</div></div><span>â–¼</span></div><div class="history-body">${r.details.map(x=>`<div class="history-row ${x.isCorrect?'correct':'wrong'}"><span>${x.question}</span><span>${x.myAnswer}</span><span>${x.answer}</span></div>`).join('')}</div>`;
            box.appendChild(card);
        });
    }
};

/* ================= GAME ================= */
const Game = {
    queue: [], idx: 0, mode: 'single', qType: 'cn_en', p1: '', p2: '', activePlayer: '', results: {}, phase: 1, isReview: false, reviewModeSetting: 'cn_en',

    init: () => {
        if(App.units.size === 0 && !Game.isReview) return alert('è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•å…ƒ');
        Game.mode = document.getElementById('mode-select').value;
        Game.qType = document.getElementById('q-type').value;
        Game.p1 = App.user;
        let pool = ALL_WORDS.filter(w => App.units.has(w.u));
        
        // è·å–é¡ºåºè®¾ç½®
        const orderSelect = document.getElementById('word-order');
        const order = orderSelect ? orderSelect.value : 'random';
        
        if (order === 'random') {
            pool.sort(() => Math.random() - 0.5);
        }
        // sequentialä¿æŒåŸé¡ºåº
        
        Game.queue = pool;
        if(Game.mode === 'battle') {
            const op = document.getElementById('opponent-select').value; if(!op) return alert('é€‰æ‹©å¯¹æ‰‹');
            Game.p2 = op; Game.activePlayer = Game.p1; Game.phase = 1; Game.results = {[Game.p1]:{score:0,log:[]},[Game.p2]:{score:0,log:[]}};
            document.getElementById('battle-info').style.display='block';
        } else {
            Game.activePlayer = Game.p1; Game.results = {[Game.p1]:{score:0,log:[]}};
            document.getElementById('battle-info').style.display='none';
        }
        Game.start();
    },
    // å¤ä¹ åŠŸèƒ½å‡çº§ï¼šè¯»å–ä¸‹æ‹‰èœå•å€¼
    reviewMistakes: () => {
        const d = DB.get()[App.user].mistakes; const w = Object.values(d);
        if(!w.length) return alert('é”™é¢˜æœ¬ä¸ºç©º');
        
        const selectedMode = document.getElementById('review-mode-select').value;
        Game.reviewModeSetting = selectedMode; // è®°å½•å¤ä¹ æ¨¡å¼
        
        // å¦‚æœæ˜¯åŸé¢˜å‹ï¼ŒqTypeæš‚æ—¶è®¾ä¸ºmixedæ ‡è®°ï¼Œå…·ä½“é¢˜å‹åœ¨loadQåˆ¤æ–­
        Game.qType = selectedMode === 'original' ? 'mixed' : selectedMode;
        
        // è·å–é”™é¢˜æœ¬é¡ºåºè®¾ç½®
        const orderSelect = document.getElementById('review-order');
        const order = orderSelect ? orderSelect.value : 'random';
        
        if (order === 'random') {
            w.sort(() => Math.random() - 0.5);
        }
        // sequentialä¿æŒåŸé¡ºåºï¼ˆæŒ‰æ·»åŠ æ—¶é—´ï¼‰
        
        Game.queue = w; Game.mode = 'single'; Game.activePlayer = App.user; Game.isReview = true;
        Game.results = {[App.user]:{score:0,log:[]}};
        document.getElementById('battle-info').style.display='none';
        Game.start();
    },
    start: () => { Game.idx = 0; App.switchView('view-quiz'); Game.loadQ(); },
    
    // é¢˜ç›®åŠ è½½å‡çº§ï¼šæ”¯æŒåŸé¢˜å‹
    loadQ: () => {
        const q = Game.queue[Game.idx];
        
        // åˆ¤å®šå½“å‰é¢˜ç›®çš„é¢˜å‹
        let currentQType = Game.qType;
        if (Game.reviewModeSetting === 'original') {
            // å¦‚æœæ˜¯åŸè®°å½•ï¼Œä¼˜å…ˆç”¨ storedTypeï¼Œæ²¡æœ‰åˆ™é»˜è®¤ cn_en
            currentQType = q.errorType || 'cn_en';
        }

        document.getElementById('feedback').innerHTML='';
        document.getElementById('current-player-display').innerText = Game.activePlayer;
        document.getElementById('progress-bar').style.width = `${(Game.idx/Game.queue.length)*100}%`;
        
        const input = document.getElementById('q-input'); input.value=''; input.disabled=false; input.focus();
        const main = document.getElementById('q-main'); const sub = document.getElementById('q-sub');
        
        // åŠ¨æ€æ¸²æŸ“
        if(currentQType === 'cn_en'){ main.innerText=q.cn; sub.innerText=q.type; Game.speak(q.cn,'zh-CN'); }
        else if(currentQType === 'en_cn'){ main.innerText=q.en; sub.innerText=q.type; Game.speak(q.en,'en-US'); }
        else { main.innerText='ğŸ§'; sub.innerText=`å¬éŸ³å†™è¯ (${q.type})`; Game.speak(q.en,'en-US'); }
        
        // æš‚å­˜å½“å‰é¢˜å‹ä»¥ä¾¿ checkAnswer ä½¿ç”¨
        Game.currentQTypeTemp = currentQType;
    },
    
    checkAnswer: () => {
        const input = document.getElementById('q-input'); const val = input.value.trim().toLowerCase();
        const q = Game.queue[Game.idx];
        const type = Game.currentQTypeTemp || Game.qType; // ä½¿ç”¨åˆšæ‰loadçš„é¢˜å‹
        
        let ok = false;
        if(type === 'en_cn') ok = q.cn.includes(val) && val.length > 0; else ok = val === q.en.toLowerCase();
        
        Game.results[Game.activePlayer].log.push({
            question: type==='cn_en'?q.cn:q.en, 
            answer: type==='cn_en'?q.en:q.cn, 
            myAnswer: val, isCorrect: ok, wordObj: q
        });
        
        const fb = document.getElementById('feedback');
        if(ok) { fb.innerHTML='<span style="color:var(--success)">âœ… æ­£ç¡®</span>'; Game.results[Game.activePlayer].score+=10; setTimeout(Game.next, 600); }
        else { fb.innerHTML=`<span style="color:var(--error)">âŒ æ­£è§£: ${type==='en_cn'?q.cn:q.en}</span>`; input.classList.add('shake'); setTimeout(()=>{input.classList.remove('shake');Game.next();},1500); }
        input.disabled = true;
    },
    
    next: () => {
        Game.idx++;
        if(Game.idx >= Game.queue.length) {
            if(Game.mode==='battle' && Game.phase===1) { App.switchView('view-intermission'); document.getElementById('next-player-name').innerText=Game.p2; }
            else Game.finish();
        } else Game.loadQ();
    },
    startPhase2: () => { Game.phase=2; Game.activePlayer=Game.p2; Game.queue.reverse(); Game.start(); },
    
    finish: () => {
        App.switchView('view-result');
        const box = document.getElementById('result-details');
        const revBox = document.getElementById('review-clear-actions');
        const btnHome = document.getElementById('btn-back-home');
        
        const players = Game.mode === 'battle' ? [Game.p1, Game.p2] : [Game.p1];
        players.forEach(p => {
            const res = Game.results[p];
            if(!res) return;
            // å­˜å†å²
            DB.addHistory(p, {
                time: Date.now(), mode: Game.mode, isReview: Game.isReview, score: res.score,
                details: res.log.map(l => ({question:l.question, answer:l.answer, myAnswer:l.myAnswer, isCorrect:l.isCorrect}))
            });
            // å­˜é”™é¢˜ (éå¤ä¹ æ¨¡å¼ä¸‹ï¼Œåªè¦é”™äº†å°±å­˜ï¼Œå¹¶ä¸”ä¼ å…¥é¢˜å‹)
            if(!Game.isReview) {
                res.log.forEach(l => { 
                    if(!l.isCorrect) DB.addMistake(p, l.wordObj, Game.qType); // ä¼ å…¥ Game.qType
                });
            }
        });

        if(Game.isReview) {
            revBox.style.display = 'block'; btnHome.style.display = 'none';
            document.getElementById('result-title').innerText = "å¤ä¹ å®Œæˆ";
            const correctLog = Game.results[App.user].log.filter(l => l.isCorrect);
            box.innerHTML = `<p>å…±å¤ä¹  ${Game.queue.length} è¯ï¼Œç­”å¯¹ ${correctLog.length} è¯ã€‚</p>`;
            const list = document.getElementById('review-correct-list'); list.innerHTML = '';
            if(!correctLog.length) list.innerHTML = '<div style="color:#999;text-align:center">æœ¬æ¬¡æ²¡æœ‰ç­”å¯¹å•è¯</div>';
            else {
                correctLog.forEach(l => {
                    const div = document.createElement('div'); div.style.padding = '5px 0'; div.style.borderBottom = '1px solid #eee';
                    div.innerHTML = `<label style="cursor:pointer;display:flex;align-items:center;"><input type="checkbox" class="review-correct-check custom-checkbox" value="${l.wordObj.id}" style="margin-right:10px"> <b>${l.wordObj.en}</b> <span style="font-size:0.8rem;color:#666;margin-left:5px">${l.wordObj.cn}</span></label>`;
                    list.appendChild(div);
                });
            }
        } else {
            revBox.style.display = 'none'; btnHome.style.display = 'inline-block';
            document.getElementById('result-title').innerText = "æŒ‘æˆ˜ç»“æŸ";
            if(Game.mode === 'battle') {
                const s1 = Game.results[Game.p1].score; const s2 = Game.results[Game.p2].score;
                box.innerHTML = `<h3>${s1 > s2 ? Game.p1+' è·èƒœ!' : (s2 > s1 ? Game.p2+' è·èƒœ!' : 'å¹³å±€')}</h3><p>${Game.p1}: ${s1} | ${Game.p2}: ${s2}</p>`;
            } else {
                box.innerHTML = `<h3>å¾—åˆ†: ${Game.results[Game.p1].score}</h3><p style="color:var(--text-sub); margin-top:10px;">âœ… ç­”é¢˜è®°å½•å·²ä¿å­˜</p><p style="color:var(--text-sub);">ğŸ“• é”™é¢˜å·²åŠ å…¥é”™é¢˜æœ¬</p>`;
            }
        }
    },

    speak: (t, l, voiceName) => {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = l;
        
        // å¦‚æœæŒ‡å®šäº†éŸ³è‰²åç§°ï¼Œä½¿ç”¨æŒ‡å®šéŸ³è‰²
        if (voiceName) {
            const voices = window.speechSynthesis.getVoices();
            const voice = voices.find(v => v.name === voiceName);
            if (voice) u.voice = voice;
        } else {
            // ä½¿ç”¨ä¿å­˜çš„è®¾ç½®
            const saved = JSON.parse(localStorage.getItem('tts_settings') || '{}');
            const savedVoiceName = l.startsWith('zh') ? saved.zh : saved.en;
            if (savedVoiceName) {
                const voices = window.speechSynthesis.getVoices();
                const voice = voices.find(v => v.name === savedVoiceName);
                if (voice) u.voice = voice;
            }
        }
        
        window.speechSynthesis.speak(u);
    },
    playAudio: () => { const q = Game.queue[Game.idx]; const t = Game.currentQTypeTemp || Game.qType; t==='cn_en'?Game.speak(q.cn,'zh-CN'):Game.speak(q.en,'en-US'); }
};

document.addEventListener('keydown', (e) => { if(e.key === 'Enter' && document.getElementById('view-quiz').classList.contains('active')) Game.checkAnswer(); });
App.init();
</script>
</body>
</html>